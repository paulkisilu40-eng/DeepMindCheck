{% extends 'base/base.html' %}
{% load static %}

{% block title %}My Wellness Plan - DeepMindCheck{% endblock %}

{% block extra_css %}
<style>
    .wellness-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .plan-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }

    .plan-header h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
    }

    .plan-header p {
        margin: 5px 0;
        opacity: 0.9;
    }

    .stats {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 8px;
        flex: 1;
        text-align: center;
    }

    .stat-card .number {
        font-size: 24px;
        font-weight: bold;
    }

    .stat-card .label {
        font-size: 12px;
        opacity: 0.9;
    }

    .day-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f7fafc;
    }

    .day-title h3 {
        margin: 0;
        color: #2d3748;
        font-size: 18px;
    }

    .day-title .date {
        color: #718096;
        font-size: 14px;
        margin-top: 4px;
    }

    .day-progress {
        background: #edf2f7;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        color: #4a5568;
    }

    .task-item {
        display: flex;
        align-items: flex-start;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 8px;
        transition: background-color 0.2s;
    }

    .task-item:hover {
        background-color: #f7fafc;
    }

    .task-item.completed {
        opacity: 0.6;
    }

    .task-item.completed .task-text {
        text-decoration: line-through;
    }

    .task-checkbox {
        margin-right: 12px;
        margin-top: 2px;
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .task-content {
        flex: 1;
    }

    .task-time {
        color: #a0aec0;
        font-size: 12px;
        margin-bottom: 4px;
    }

    .task-text {
        color: #2d3748;
        font-size: 15px;
    }

    .mood-section {
        background: #f7fafc;
        padding: 25px;
        border-radius: 12px;
        margin: 30px 0;
        text-align: center;
    }

    .mood-section h3 {
        margin: 0 0 20px 0;
        color: #2d3748;
    }

    .mood-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    .mood-btn {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 28px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .mood-btn:hover {
        transform: scale(1.1);
        border-color: #667eea;
    }

    .mood-btn.selected {
        border-color: #667eea;
        background: #667eea;
        transform: scale(1.15);
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        margin: 30px 0;
    }

    .btn {
        flex: 1;
        padding: 15px 25px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5568d3;
    }

    .btn-secondary {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }

    .btn-secondary:hover {
        background: #f7fafc;
    }

    .crisis-resources {
        background: #fff5f5;
        border: 2px solid #feb2b2;
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
    }

    .crisis-resources h3 {
        color: #c53030;
        margin: 0 0 15px 0;
    }

    .crisis-resources ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .crisis-resources li {
        padding: 8px 0;
        color: #742a2a;
    }

    .success-message {
        background: #c6f6d5;
        color: #22543d;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="wellness-container">
    <div id="successMessage" class="success-message"></div>

    <div class="plan-header">
        <h1>üåü 7-Day Wellness Journey</h1>
        <p>Your Wellness Action Plan</p>
        <p><strong>Generated for:</strong> {{ plan.mental_state }}</p>

        <div class="stats">
            <div class="stat-card">
                <div class="number" id="streakCount">0</div>
                <div class="label">Day Streak</div>
            </div>
            <div class="stat-card">
                <div class="number" id="overallProgress">0%</div>
                <div class="label">Complete</div>
            </div>
        </div>
    </div>

    {% for day in plan.days %}
    <div class="day-card" data-day="{{ day.day }}">
        <div class="day-header">
            <div class="day-title">
                <h3>Day {{ day.day }}: {{ day.focus }}</h3>
                <div class="date">{{ day.date }}</div>
            </div>
            <div class="day-progress">
                <span class="progress-text">0/{{ day.tasks|length }}</span>
            </div>
        </div>

        <div class="tasks-list">
            {% for task in day.tasks %}
            <div class="task-item">
                <input type="checkbox" class="task-checkbox" id="task-{{ day.day }}-{{ forloop.counter }}"
                    data-day="{{ day.day }}" data-task="{{ forloop.counter }}">
                <label for="task-{{ day.day }}-{{ forloop.counter }}" class="task-content">
                    <div class="task-time">{{ task.time }}</div>
                    <div class="task-text">{{ task.icon }} {{ task.text }}</div>
                </label>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <div class="mood-section">
        <h3>Mood Check-in</h3>
        <p>How are you feeling about your progress?</p>
        <div class="mood-buttons">
            <button class="mood-btn" data-mood="1" aria-label="Very sad">üò¢</button>
            <button class="mood-btn" data-mood="2" aria-label="Sad">üôÅ</button>
            <button class="mood-btn" data-mood="3" aria-label="Neutral">üòê</button>
            <button class="mood-btn" data-mood="4" aria-label="Happy">üôÇ</button>
            <button class="mood-btn" data-mood="5" aria-label="Very happy">ü§©</button>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn btn-primary" id="savePlanBtn">
            üíæ Save Plan
        </button>
        <button class="btn btn-secondary" id="downloadPdfBtn">
            üìÑ Download PDF
        </button>
    </div>

    <div class="crisis-resources">
        <h3>üÜò CRISIS RESOURCES</h3>
        <ul>
            <li>üìû 988 Suicide & Crisis Lifeline</li>
            <li>üì± Text HOME to 741741</li>
            <li>üè• Campus Health: (555) 123-4567</li>
        </ul>
    </div>
</div>

<!-- Hidden script tag to safely pass plan data to JavaScript -->
{{ plan|json_script:"plan-data" }}

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Load saved progress from localStorage
        loadProgress();

        // Task checkbox handling
        const checkboxes = document.querySelectorAll('.task-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const taskItem = this.closest('.task-item');
                taskItem.classList.toggle('completed', this.checked);

                // Save progress
                saveProgress();

                // Update progress displays
                updateDayProgress(this.dataset.day);
                updateOverallProgress();
                updateStreak();
            });
        });

        // Mood button handling
        const moodButtons = document.querySelectorAll('.mood-btn');
        moodButtons.forEach(button => {
            button.addEventListener('click', function () {
                moodButtons.forEach(btn => btn.classList.remove('selected'));
                this.classList.add('selected');

                const mood = this.dataset.mood;
                localStorage.setItem('currentMood', mood);

                showMessage('Mood saved! üòä');
            });
        });

        // Load saved mood
        const savedMood = localStorage.getItem('currentMood');
        if (savedMood) {
            const moodBtn = document.querySelector(`[data-mood="${savedMood}"]`);
            if (moodBtn) moodBtn.classList.add('selected');
        }

        // Save plan button
        document.getElementById('savePlanBtn').addEventListener('click', async function () {
            {% if user.is_authenticated %}
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            try {
                // Get plan data from the JSON script tag
                const planData = JSON.parse(document.getElementById('plan-data').textContent);
                
                const response = await fetch('/api/save-wellness-plan/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        mental_state: '{{ plan.mental_state }}',
                        plan_data: planData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    saveProgress(); // Also save local progress
                    showMessage('Plan saved to your profile! ‚úÖ');
                    btn.innerHTML = '<i class="fas fa-check"></i> Saved';
                } else {
                    throw new Error(data.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error saving plan:', error);
                showMessage('Error saving plan to profile. Local progress saved. ‚ö†Ô∏è');
            } finally {
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }
            {% else %}
            saveProgress();
            showMessage('Progress saved locally! Login to save permanently. üíæ');
            // Optional: Redirect to login or show modal
            if (confirm("Would you like to login to save this plan to your profile?")) {
                window.location.href = "{% url 'login' %}?next=" + encodeURIComponent(window.location.pathname + window.location.search);
            }
            {% endif %}
        });

        // Download PDF button
        document.getElementById('downloadPdfBtn').addEventListener('click', function () {
            // In production, this would trigger a server-side PDF generation
            alert('PDF download feature would be implemented on the backend. Your progress has been saved!');
            // Uncomment when backend endpoint is ready:
            // window.location.href = "{% url 'download_wellness_pdf' %}";
        });

        function updateDayProgress(dayNumber) {
            const dayCard = document.querySelector(`[data-day="${dayNumber}"]`);
            const checkboxes = dayCard.querySelectorAll('.task-checkbox');
            const completed = dayCard.querySelectorAll('.task-checkbox:checked').length;
            const total = checkboxes.length;

            const progressText = dayCard.querySelector('.progress-text');
            progressText.textContent = `${completed}/${total}`;
        }

        function updateOverallProgress() {
            const allCheckboxes = document.querySelectorAll('.task-checkbox');
            const completedCheckboxes = document.querySelectorAll('.task-checkbox:checked');
            const percentage = Math.round((completedCheckboxes.length / allCheckboxes.length) * 100);

            document.getElementById('overallProgress').textContent = `${percentage}%`;
        }

        function updateStreak() {
            const days = document.querySelectorAll('.day-card');
            let streak = 0;

            days.forEach(day => {
                const checkboxes = day.querySelectorAll('.task-checkbox');
                const completed = day.querySelectorAll('.task-checkbox:checked').length;

                if (completed === checkboxes.length && checkboxes.length > 0) {
                    streak++;
                } else if (streak > 0) {
                    return; // Break on first incomplete day
                }
            });

            document.getElementById('streakCount').textContent = streak;
        }

        function saveProgress() {
            const progress = {};
            const checkboxes = document.querySelectorAll('.task-checkbox');

            checkboxes.forEach(checkbox => {
                const key = `day${checkbox.dataset.day}-task${checkbox.dataset.task}`;
                progress[key] = checkbox.checked;
            });

            localStorage.setItem('wellnessProgress', JSON.stringify(progress));
        }

        function loadProgress() {
            const saved = localStorage.getItem('wellnessProgress');
            if (!saved) return;

            const progress = JSON.parse(saved);

            Object.keys(progress).forEach(key => {
                const [dayPart, taskPart] = key.split('-');
                const day = dayPart.replace('day', '');
                const task = taskPart.replace('task', '');

                const checkbox = document.querySelector(`[data-day="${day}"][data-task="${task}"]`);
                if (checkbox) {
                    checkbox.checked = progress[key];
                    const taskItem = checkbox.closest('.task-item');
                    taskItem.classList.toggle('completed', progress[key]);
                }
            });

            // Update all displays
            const days = document.querySelectorAll('.day-card');
            days.forEach(day => {
                updateDayProgress(day.dataset.day);
            });
            updateOverallProgress();
            updateStreak();
        }

        function showMessage(message) {
            const msgEl = document.getElementById('successMessage');
            msgEl.textContent = message;
            msgEl.style.display = 'block';

            setTimeout(() => {
                msgEl.style.display = 'none';
            }, 3000);
        }
    });
</script>
{% endblock %}